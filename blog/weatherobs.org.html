<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.43 in css mode. -->
<html>
  <head>
    <title>weatherobs.org</title>
    <style type="text/css">
    <!--
      body {
        color: #333333;
        background-color: #F6F6EF;
      }
      .comment {
        /* font-lock-comment-face */
        color: #8D8D84;
        font-style: italic;
      }
      .comment-delimiter {
        /* font-lock-comment-delimiter-face */
        color: #8D8D84;
      }
      .constant {
        /* font-lock-constant-face */
        color: #D0372D;
      }
      .default {
        /* default */
        color: #333333;
        background-color: #F6F6EF;
      }
      .doc {
        /* font-lock-doc-face */
        color: #036A07;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #006699;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #0000FF;
      }
      .org-block {
        /* org-block */
        color: #000088;
        background-color: #FFFFE0;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #555555;
        background-color: #E2E1D5;
        text-decoration: underline;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #555555;
        background-color: #E2E1D5;
        text-decoration: overline;
      }
      .org-code {
        /* org-code */
        color: #006400;
        background-color: #FDFFF7;
      }
      .org-date {
        /* org-date */
        color: #00459E;
        text-decoration: underline;
      }
      .org-document-info {
        /* org-document-info */
        color: #484848;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #008ED1;
        background-color: #EAEAFF;
      }
      .org-document-title {
        /* org-document-title */
        color: #000000;
        font-size: 180%;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #3C3C3C;
        background-color: #F0F0F0;
        font-size: 130%;
        font-weight: bold;
        text-decoration: overline;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #123555;
        background-color: #E5F4FB;
        font-weight: bold;
        text-decoration: overline;
      }
      .org-level-3 {
        /* org-level-3 */
        color: #005522;
        background-color: #EFFFEF;
        font-weight: bold;
      }
      .org-link {
        /* org-link */
        color: #006DAF;
        text-decoration: underline;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #008ED1;
        background-color: #EAEAFF;
      }
      .org-special-keyword {
        /* org-special-keyword */
        color: #00BB00;
        background-color: #EAFFEA;
        font-weight: bold;
      }
      .org-table {
        /* org-table */
        color: #006400;
        background-color: #EAFFEA;
      }
      .org-tag {
        /* org-tag */
        color: #9A9FA4;
        background-color: #ffffff;
        font-style: italic;
      }
      .org-target {
        /* org-target */
        color: #006DAF;
        text-decoration: underline;
      }
      .rainbow-delimiters-depth-1 {
        /* rainbow-delimiters-depth-1-face */
        color: #707183;
      }
      .rainbow-delimiters-depth-2 {
        /* rainbow-delimiters-depth-2-face */
        color: #7388D6;
      }
      .rainbow-delimiters-depth-3 {
        /* rainbow-delimiters-depth-3-face */
        color: #909183;
      }
      .rainbow-delimiters-depth-4 {
        /* rainbow-delimiters-depth-4-face */
        color: #709870;
      }
      .rainbow-delimiters-depth-5 {
        /* rainbow-delimiters-depth-5-face */
        color: #907373;
      }
      .rainbow-delimiters-depth-6 {
        /* rainbow-delimiters-depth-6-face */
        color: #6276BA;
      }
      .rainbow-delimiters-depth-7 {
        /* rainbow-delimiters-depth-7-face */
        color: #858580;
      }
      .rainbow-delimiters-depth-8 {
        /* rainbow-delimiters-depth-8-face */
        color: #80A880;
      }
      .string {
        /* font-lock-string-face */
        color: #008000;
      }
      .type {
        /* font-lock-type-face */
        color: #6434A3;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #BA36A5;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-meta-line">#+OPTIONS: ':nil *:t -:t ::t &lt;:t H:3 \n:nil ^:t arch:headline author:t c:nil</span>
<span class="org-meta-line">#+OPTIONS: creator:nil d:(not "LOGBOOK") date:t e:t email:nil f:t inline:t</span>
<span class="org-meta-line">#+OPTIONS: num:nil p:nil pri:nil prop:nil stat:t tags:t tasks:t tex:t timestamp:t</span>
<span class="org-meta-line">#+OPTIONS: title:t toc:nil todo:t |:t</span>
<span class="org-document-info-keyword">#+TITLE:</span> <span class="org-document-title">Plotting Time Series of Weather Observations in Emacs
</span><span class="org-document-info-keyword">#+DATE:</span> <span class="org-document-info">&lt;2017-02-25 Sat&gt;
</span><span class="org-document-info-keyword">#+AUTHOR:</span> <span class="org-document-info">Julien Chastang
</span><span class="org-document-info-keyword">#+EMAIL:</span> <span class="org-document-info">julien dot c dot chastang at gmail
</span><span class="org-meta-line">#+LANGUAGE: en</span>
<span class="org-meta-line">#+SELECT_TAGS: export</span>
<span class="org-meta-line">#+EXCLUDE_TAGS: noexport</span>
<span class="org-meta-line">#+CREATOR: Emacs 24.5.1 (Org mode 8.3.6)</span>

<span class="org-meta-line">#+SETUPFILE: ../../templates/level-1.org</span>
<span class="org-meta-line">#+INCLUDE: ../../templates/level-1.org</span>

<span class="org-meta-line">#+PROPERTY: header-args :exports both</span>

<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp :results silent :exports none  :tangle no
</span>  <span class="rainbow-delimiters-depth-1">(</span>setq org-confirm-babel-evaluate nil<span class="rainbow-delimiters-depth-1">)</span>
  <span class="rainbow-delimiters-depth-1">(</span>setq org-export-babel-evaluate nil<span class="rainbow-delimiters-depth-1">)</span>
<span class="org-block-end-line">#+END_SRC
</span>
<span class="org-level-1">* </span><span class="org-date">&lt;2017-02-25 Sat&gt;</span>

<span class="org-link"><a href="file:~/git/julienchastang/src/static/weatherobs/timeseries.svg">file:~/git/julienchastang/src/static/weatherobs/timeseries.svg</a></span>

<span class="org-level-2">** Introduction</span>
<span class="org-target">&lt;&lt;intro&gt;&gt;</span>

In this post, we will be using Emacs and org-mode to construct a time series of weather observations. If you want the short version of what we will be doing, change the <span class="org-code">~station-id~</span> below and run <span class="org-code">~org-babel-execute-buffer~</span> (<span class="org-code">~C-c C-v C-b~</span>). For the complete version read on. We will be using the following technologies:
  - <span class="org-link"><a href="http://orgmode.org">org-mode</a></span>
  - <span class="org-link"><a href="https://github.com/zweifisch/ob-http">ob-http</a></span>, http requests in org Babel
  - <span class="org-link"><a href="https://www.gnu.org/software/emacs/manual/html_node/org/noweb.html">noweb</a></span> literate programming
  - <span class="org-link"><a href="http://www.gnuplot.info/">gnuplot</a></span>, the venerable plotting utility
  - <span class="org-link"><a href="https://synopticlabs.org/">Mesowest Synoptic Labs API</a></span>

The org source for this file is located at the source link at the bottom of the page. Indeed, to follow along carefully you will have to view that source link as the HTML rendering has removed some of the org source from this web page.
<span class="org-level-2">** Find a Weather Station</span>

Our first job is to find a weather station near our location. We will employ the SynopticLabs Mesonet API to identify a station ID near my current location. I live in Boulder, Colorado at roughly these coordinates: 39.99, -105.22. The Mesonet API has a service to find weather stations nearest a given latitude and longitude point. You have to supply a US <span class="org-code">~state~</span> (easy to forget) and a <span class="org-code">~radius~</span> arguments composed of a latitude, longitude center and a radius distance in miles. In addition, there are a couple of other ancillary arguments including a demo token. Consult the API documentation to ensure you are working within the <span class="org-link"><a href="https://synopticlabs.org/api/legal/">terms of use</a></span>. The following URL will provide us a station near by with the help of ob-http:

<span class="org-level-3">*** ob-http Request and JSON Response</span>

<span class="org-block-begin-line">#+BEGIN_SRC http :pretty
</span>  <span class="constant">GET</span> <a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">http</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">:</a></span><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">//api.mesowest.net/v2/stations/metadata</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">?</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">state</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">co</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">status</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">active</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">radius</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">=</a></span><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">39.99</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">,</a></span><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">-105.22</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">,</a></span><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">1</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">token</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/metadata?state=co&amp;status=active&amp;radius=39.99,-105.22,1&amp;token=demotoken">demotoken</a></span>
<span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS:</span>
<span class="org-block-begin-line">#+begin_example
</span><span class="org-block">{
   "SUMMARY": {
     "METADATA_RESPONSE_TIME": "0.0970363616943 ms",
     "RESPONSE_MESSAGE": "OK",
     "RESPONSE_CODE": 1,
     "NUMBER_OF_OBJECTS": 1
   },
  "STATION": [
    {
       "ID": "41017",
       "TIMEZONE": "America\/Denver",
       "LATITUDE": "40.00133",
       "STATE": "CO",
       "LONGITUDE": "-105.23033",
       "STID": "E3608",
       "DISTANCE": 0.96,
       "NAME": "EW3608 Boulder",
       "ELEVATION": "5430",
      "PERIOD_OF_RECORD": {
         "end": "2017-02-28T23:58:00Z",
         "start": "2013-09-25T00:00:00Z"
      },
       "MNET_ID": "65",
       "STATUS": "ACTIVE"
    }
   ]
}
</span><span class="org-block-end-line">#+end_example
</span>

According to this JSON response, there is the "E3608" weather station not far away. We will work with the data from that instrument.

<span class="org-level-2">** Timeseries API</span>

Next, we will be using the <span class="org-link"><a href="https://synopticlabs.org/api/mesonet/reference/#stationstimeseries">timeseries API</a></span> to retrieve the station data. For example, the following URL retrieves the air temperature from the KDEN station for the last 30 minutes.

<span class="org-block-begin-line">#+BEGIN_SRC http :pretty
</span>  <span class="constant">GET</span> <a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">http</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">:</a></span><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">//api.mesowest.net/v2/stations/timeseries</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">?&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">stid</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">kden</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">recent</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">30</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">token</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">demotoken</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">vars</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">air_temp</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">output</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/timeseries?&amp;stid=kden&amp;recent=30&amp;token=demotoken&amp;vars=air_temp&amp;output=csv">csv</a></span>
<span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS:</span>
<span class="org-block-begin-line">#+begin_example
</span><span class="org-block"># STATION: KDEN
# STATION NAME: Denver, Denver International Airport
# LATITUDE: 39.84658
# LONGITUDE: -104.65622
# ELEVATION [ft]: 5404
# STATE: CO
Station_ID,Date_Time,air_temp_set_1
,,Celsius
 KDEN,2017-02-28T23:35:00Z,-2.0
 KDEN,2017-02-28T23:40:00Z,-2.0
 KDEN,2017-02-28T23:45:00Z,-2.0
 KDEN,2017-02-28T23:50:00Z,-2.0
 KDEN,2017-02-28T23:53:00Z,-2.2
 KDEN,2017-02-28T23:55:00Z,-2.0
</span><span class="org-block-end-line">#+end_example
</span>
There are more <span class="org-link"><a href="https://synopticlabs.org/api/mesonet/">examples</a></span> of API use as well as the <span class="org-link"><a href="https://synopticlabs.org/api/mesonet/reference/#stationstimeseries">API reference</a></span> on SynopticLabs website. 

For the particular example we are shooting for, we will supply the following URL parameters:

  - <span class="org-code">~stid~</span>, the station ID that we obtained earlier
  - <span class="org-code">~start~</span>, the start time in UTC (e.g., <span class="org-code">~201702171644~</span>)
  - <span class="org-code">~end~</span>, the end time  in UTC (e.g., <span class="org-code">~201702241644~</span>)
  - <span class="org-code">~units~</span>, the desired units (i.e., metrics or english)
  - <span class="org-code">~vars~</span>, the <span class="org-link"><a href="https://synopticlabs.org/api/mesonet/variables/">sensor variables</a></span>
  - <span class="org-code">~obtimezone~</span>, the timezone of the response data (i.e., UTC or local)
  - <span class="org-code">~output~</span>, the output format (e.g., csv) 
  - <span class="org-code">~token~</span>, the request token in this case guest

<span class="org-level-2">** Set up Parameterization With noweb</span>
<span class="org-target">&lt;&lt;params&gt;&gt;</span>

We will once again be make use of ob-http to retrieve the data, but, this time, we will be employing the Emacs noweb facility to parameterize the ob-http code block. (By the way, "noweb", has always struck me as a terrible name as it seems to imply something about the web browsing, the world wide web, or the Internet, but, in fact, refers to a literate programming style.) Let's start defining our noweb parameters with named org-mode and Emacs Lisp code blocks. We will use the names subsequently via noweb.

<span class="org-level-3">*** Start Time</span>

Obtain the start time range will be 24 hours ago. Also set the time zone as UTC since that is what the SynopticLabs API requires.

<span class="org-meta-line">#+NAME: starttime</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp
</span>  <span class="rainbow-delimiters-depth-1">(</span>setenv <span class="string">"TZ"</span> <span class="string">"UTC0"</span><span class="rainbow-delimiters-depth-1">)</span>
   <span class="rainbow-delimiters-depth-1">(</span>format-time-string <span class="string">"%Y%m%d%H%M"</span> <span class="rainbow-delimiters-depth-2">(</span>time-add
                                     <span class="rainbow-delimiters-depth-3">(</span>current-time<span class="rainbow-delimiters-depth-3">)</span>
                                     <span class="rainbow-delimiters-depth-3">(</span>seconds-to-time <span class="rainbow-delimiters-depth-4">(</span>- <span class="rainbow-delimiters-depth-5">(</span>* 1 24 60 60<span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">)</span><span class="rainbow-delimiters-depth-1">)</span>
<span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: starttime</span>
<span class="org-code"> : 201702280006
</span>
<span class="org-level-3">*** End Time</span>

The end time will be now.

<span class="org-meta-line">#+NAME: endtime</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp
</span>  <span class="rainbow-delimiters-depth-1">(</span>format-time-string <span class="string">"%Y%m%d%H%M"</span><span class="rainbow-delimiters-depth-1">)</span>
<span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: endtime</span>
<span class="org-code"> : 201703010006
</span>
<span class="org-level-3">*** Station ID</span>

The station ID we found earlier.

<span class="org-meta-line">#+NAME: station-id</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp
</span>  <span class="comment-delimiter">;; </span><span class="comment">"KBJC"
</span>  <span class="string">"E3608"</span>
  <span class="comment-delimiter">;; </span><span class="comment">"E7829"
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: station-id</span>
<span class="org-code">: E3608
</span>
<span class="org-level-2">** Retrieve the Weather Observations</span>
<span class="org-level-3">*** Retrieve Data</span>

At this point, we can finally retrieve our data with the help our noweb parameters. For example, <span class="org-code">~</span><span class="org-code"><span class="org-target">&lt;&lt;starttime()&gt;&gt;</span></span><span class="org-code">~</span> will invoke the <span class="org-code">~starttime~</span> code block defined above and insert the result into the http address below. The same is true for <span class="org-code">~station-id~</span> and <span class="org-code">~endtime~</span>. See the source link at the bottom to see the noweb parameterization.

<span class="org-meta-line">#+NAME: timeseries</span>
<span class="org-block-begin-line">#+BEGIN_SRC http :pretty :results silent :noweb yes
</span><span class="constant">GET</span> <a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">http</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">:</a></span><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">//api.mesowest.net/v2/stations/timeseries</a><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">?</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">token</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">=</a></span><span class="string"><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">demotoken</a></span><span class="comment"><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">&amp;</a></span><span class="variable-name"><a href="http://api.mesowest.net/v2/stations/timeseries?token=demotoken&amp;stid">stid</a></span><span class="comment">=</span><span class="string">&lt;&lt;station-id()&gt;&gt;</span><span class="comment">&amp;</span><span class="variable-name">start</span><span class="comment">=</span><span class="string">&lt;&lt;starttime()&gt;&gt;</span><span class="comment">&amp;</span><span class="variable-name">end</span><span class="comment">=</span><span class="string">&lt;&lt;endtime()&gt;&gt;</span><span class="comment">&amp;</span><span class="variable-name">obtimezone</span><span class="comment">=</span><span class="string">local</span><span class="comment">&amp;</span><span class="variable-name">units</span><span class="comment">=</span><span class="string">metric</span><span class="comment">&amp;</span><span class="variable-name">vars</span><span class="comment">=</span>air_temp<span class="comment">,</span>dew_point_temperature<span class="comment">,</span>wind_speed<span class="comment">,</span>wind_direction<span class="comment">,</span>sea_level_pressure<span class="comment">&amp;</span><span class="variable-name">output</span><span class="comment">=</span><span class="string">csv</span>
<span class="org-block-end-line">#+END_SRC
</span>
<span class="org-level-3">*** Post-request cleanup with Emacs Lisp</span>

At this point, we have to write some Emacs Lisp to clean up the response data and make it more org-mode friendly. We will need four helper functions:

  - <span class="org-code">~take-nth~</span> is a function to sample data at certain intervals from a list.
  - gnuplot does not like empty org-table cells so the <span class="org-code">~fix-missing~</span> function replaces empty cells with the "missing" string.
  - The <span class="org-code">~find-header~</span> function locates where the header and actual data are located in the CSV http response.
  - The <span class="org-code">~clean-header~</span> function replaces cryptic columns names with ones that are easier to understand.

Armed with these functions, we can clean up our data. Also a note about sampling: large org-tables tend to bog down Emacs so I'm limiting the table size to 30 samples via a Babel header argument, and the <span class="org-code">~take-nth~</span> helper function.

<span class="org-meta-line">#+NAME: data-table</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp :var data=timeseries :var samples=30 :results table drawer
</span>  <span class="rainbow-delimiters-depth-1">(</span><span class="keyword">defun</span> <span class="function-name">take-nth</span> <span class="rainbow-delimiters-depth-2">(</span>n list <span class="rainbow-delimiters-depth-2">)</span>
    <span class="doc">"Returns a list of every nth item in the list."</span>
    <span class="rainbow-delimiters-depth-2">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3">(</span>&lt;= n 1<span class="rainbow-delimiters-depth-3">)</span> list
      <span class="rainbow-delimiters-depth-3">(</span><span class="keyword">when</span> list
        <span class="rainbow-delimiters-depth-4">(</span>cons <span class="rainbow-delimiters-depth-5">(</span>car list<span class="rainbow-delimiters-depth-5">)</span>
              <span class="rainbow-delimiters-depth-5">(</span>take-nth n <span class="rainbow-delimiters-depth-6">(</span>nthcdr n list<span class="rainbow-delimiters-depth-6">)</span><span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">)</span><span class="rainbow-delimiters-depth-1">)</span>

  <span class="rainbow-delimiters-depth-1">(</span><span class="keyword">defun</span> <span class="function-name">fix-missing</span> <span class="rainbow-delimiters-depth-2">(</span>s<span class="rainbow-delimiters-depth-2">)</span>
    <span class="doc">"Replace missing CSV values with 'missing' to avoid empty cells in org-tables."</span>
    <span class="rainbow-delimiters-depth-2">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-3">(</span>string-match-p <span class="string">",\s*,"</span> s<span class="rainbow-delimiters-depth-3">)</span>
        <span class="rainbow-delimiters-depth-3">(</span>fix-missing <span class="rainbow-delimiters-depth-4">(</span>replace-regexp-in-string <span class="string">",\s*,"</span> <span class="string">",missing,"</span> s<span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span>
      s<span class="rainbow-delimiters-depth-2">)</span><span class="rainbow-delimiters-depth-1">)</span>

  <span class="rainbow-delimiters-depth-1">(</span><span class="keyword">defun</span> <span class="function-name">find-header</span> <span class="rainbow-delimiters-depth-2">(</span>list<span class="rainbow-delimiters-depth-2">)</span>
    <span class="doc">"Find row in the CSV data where the column header info starts."</span>
    <span class="rainbow-delimiters-depth-2">(</span><span class="keyword">when</span> list
      <span class="rainbow-delimiters-depth-3">(</span><span class="keyword">if</span> <span class="rainbow-delimiters-depth-4">(</span>string-prefix-p <span class="string">"Station_ID"</span> <span class="rainbow-delimiters-depth-5">(</span>car list<span class="rainbow-delimiters-depth-5">)</span> <span class="rainbow-delimiters-depth-4">)</span>
          list 
        <span class="rainbow-delimiters-depth-4">(</span>find-header <span class="rainbow-delimiters-depth-5">(</span>cdr list<span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">)</span><span class="rainbow-delimiters-depth-1">)</span>

  <span class="rainbow-delimiters-depth-1">(</span><span class="keyword">defun</span> <span class="function-name">clean-header</span> <span class="rainbow-delimiters-depth-2">(</span>header<span class="rainbow-delimiters-depth-2">)</span>
    <span class="doc">"Provide better names for column headers provided by the API."</span>
    <span class="rainbow-delimiters-depth-2">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-3">(</span><span class="rainbow-delimiters-depth-4">(</span>col-map '<span class="rainbow-delimiters-depth-5">(</span><span class="rainbow-delimiters-depth-6">(</span><span class="string">"Station_ID"</span> . <span class="string">"Station"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"Date_Time"</span> . <span class="string">"Date Time"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"altimeter_set_1"</span> . <span class="string">"Altimeter"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"air_temp_set_1"</span> . <span class="string">"Temperature"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"relative_humidity_set_1"</span> . <span class="string">"RH"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"wind_speed_set_1"</span> . <span class="string">"Wind Speed"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"wind_direction_set_1"</span> . <span class="string">"Wind Direction"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"dew_point_temperature_set_1d"</span> . <span class="string">"Dew Point"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"pressure_set_1d"</span> . <span class="string">"Pressure"</span><span class="rainbow-delimiters-depth-6">)</span>
                      <span class="rainbow-delimiters-depth-6">(</span><span class="string">"sea_level_pressure_set_1d"</span> . <span class="string">"SLP"</span><span class="rainbow-delimiters-depth-6">)</span><span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span>
      <span class="rainbow-delimiters-depth-3">(</span>mapcar <span class="rainbow-delimiters-depth-4">(</span><span class="keyword">lambda</span> <span class="rainbow-delimiters-depth-5">(</span>x<span class="rainbow-delimiters-depth-5">)</span> <span class="rainbow-delimiters-depth-5">(</span>cdr <span class="rainbow-delimiters-depth-6">(</span>assoc x col-map<span class="rainbow-delimiters-depth-6">)</span><span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span>
              <span class="rainbow-delimiters-depth-4">(</span>split-string header <span class="string">","</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">)</span><span class="rainbow-delimiters-depth-1">)</span>

  <span class="rainbow-delimiters-depth-1">(</span><span class="keyword">let*</span> <span class="rainbow-delimiters-depth-2">(</span><span class="rainbow-delimiters-depth-3">(</span>string-data <span class="rainbow-delimiters-depth-4">(</span>split-string data<span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span>
         <span class="rainbow-delimiters-depth-3">(</span>rows <span class="rainbow-delimiters-depth-4">(</span>find-header string-data<span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span>
         <span class="rainbow-delimiters-depth-3">(</span>col-hdrs <span class="rainbow-delimiters-depth-4">(</span>clean-header <span class="rainbow-delimiters-depth-5">(</span>car rows<span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span>
         <span class="rainbow-delimiters-depth-3">(</span>units <span class="rainbow-delimiters-depth-4">(</span>split-string <span class="rainbow-delimiters-depth-5">(</span>cadr rows<span class="rainbow-delimiters-depth-5">)</span> <span class="string">","</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span>
         <span class="rainbow-delimiters-depth-3">(</span>d <span class="rainbow-delimiters-depth-4">(</span>take-nth <span class="rainbow-delimiters-depth-5">(</span>/ <span class="rainbow-delimiters-depth-6">(</span>length rows<span class="rainbow-delimiters-depth-6">)</span> samples<span class="rainbow-delimiters-depth-5">)</span> <span class="rainbow-delimiters-depth-5">(</span>cddr rows<span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">)</span>
    <span class="rainbow-delimiters-depth-2">(</span>cons col-hdrs
          <span class="rainbow-delimiters-depth-3">(</span>cons units
                <span class="rainbow-delimiters-depth-4">(</span><span class="keyword">cl-loop</span> for s in d
                         collect
                         <span class="rainbow-delimiters-depth-5">(</span><span class="keyword">let</span> <span class="rainbow-delimiters-depth-6">(</span><span class="rainbow-delimiters-depth-7">(</span>row <span class="rainbow-delimiters-depth-8">(</span>fix-missing s<span class="rainbow-delimiters-depth-8">)</span><span class="rainbow-delimiters-depth-7">)</span><span class="rainbow-delimiters-depth-6">)</span>
                           <span class="rainbow-delimiters-depth-6">(</span>split-string row <span class="string">","</span><span class="rainbow-delimiters-depth-6">)</span><span class="rainbow-delimiters-depth-5">)</span><span class="rainbow-delimiters-depth-4">)</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">)</span><span class="rainbow-delimiters-depth-1">)</span>
<span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: data-table</span>
<span class="org-special-keyword">:RESULTS:</span>
<span class="org-table"> | Station | Date Time                | Altimeter | Temperature |      RH |    Wind Speed | Wind Direction | Dew Point | Pressure |       SLP |</span>
<span class="org-table"> |         |                          |   Pascals |     Celsius |       % | Meters/second |        Degrees |   Celsius |  Pascals |   Pascals |</span>
<span class="org-table"> | E3608   | 2017-02-27T17:08:00-0700 | 100507.97 |        9.44 |    26.0 |          2.68 |          223.0 |     -9.23 | 82282.05 | 100132.09 |</span>
<span class="org-table"> | E3608   | 2017-02-27T17:53:00-0700 | 100541.83 |        8.33 |    30.0 |           0.0 |        missing |     -8.37 | 82309.77 | 100241.92 |</span>
<span class="org-table"> | E3608   | 2017-02-27T18:38:00-0700 | 100643.42 |        7.22 |    34.0 |           0.0 |        missing |     -7.73 | 82392.94 | 100420.05 |</span>
<span class="org-table"> | E3608   | 2017-02-27T19:23:00-0700 | 100677.29 |        8.33 |    28.0 |          3.13 |          215.0 |     -9.25 | 82420.66 |  100377.0 |</span>
<span class="org-table"> | E3608   | 2017-02-27T20:08:00-0700 | 100711.15 |        7.22 |    32.0 |          0.45 |          248.0 |     -8.51 | 82448.38 | 100487.64 |</span>
<span class="org-table"> | E3608   | 2017-02-27T20:53:00-0700 | 100745.01 |         5.0 |    42.0 |          0.45 |          250.0 |     -6.97 |  82476.1 | 100677.22 |</span>
<span class="org-table"> | E3608   | 2017-02-27T21:38:00-0700 |  100846.6 |        1.11 |    66.0 |          3.13 |           75.0 |     -4.61 | 82559.27 |  101058.6 |</span>
<span class="org-table"> | E3608   | 2017-02-27T22:23:00-0700 | 101015.92 |        0.56 |    68.0 |          0.45 |          105.0 |     -4.73 | 82697.89 | 101268.63 |</span>
<span class="org-table"> | E3608   | 2017-02-27T23:08:00-0700 | 101049.79 |         0.0 |    69.0 |           0.9 |          192.0 |     -5.08 | 82725.62 | 101343.86 |</span>
<span class="org-table"> | E3608   | 2017-02-27T23:53:00-0700 | 101049.79 |         0.0 |    71.0 |           0.9 |          133.0 |     -4.69 | 82725.62 | 101343.85 |</span>
<span class="org-table"> | E3608   | 2017-02-28T00:38:00-0700 | 101049.79 |       -0.56 |    72.0 |          0.45 |          173.0 |     -5.05 | 82725.62 | 101385.31 |</span>
<span class="org-table"> | E3608   | 2017-02-28T01:23:00-0700 | 101083.65 |       -0.56 |    71.0 |          0.45 |          144.0 |     -5.23 | 82753.33 | 101419.28 |</span>
<span class="org-table"> | E3608   | 2017-02-28T02:08:00-0700 | 101083.65 |       -0.56 |    71.0 |          1.34 |          184.0 |     -5.23 | 82753.33 | 101419.28 |</span>
<span class="org-table"> | E3608   | 2017-02-28T02:53:00-0700 | 101015.92 |       -1.11 |    74.0 |          1.34 |          188.0 |     -5.21 | 82697.89 | 101392.21 |</span>
<span class="org-table"> | E3608   | 2017-02-28T03:38:00-0700 | 101015.92 |       -0.56 |    70.0 |          1.34 |          161.0 |     -5.42 | 82697.89 | 101351.34 |</span>
<span class="org-table"> | E3608   | 2017-02-28T04:23:00-0700 | 101015.92 |       -0.56 |    66.0 |           0.9 |          190.0 |      -6.2 | 82697.89 | 101351.37 |</span>
<span class="org-table"> | E3608   | 2017-02-28T05:08:00-0700 | 101049.79 |       -0.56 |    66.0 |          0.45 |          184.0 |      -6.2 | 82725.62 | 101385.36 |</span>
<span class="org-table"> | E3608   | 2017-02-28T05:53:00-0700 | 101049.79 |       -1.11 |    68.0 |           0.0 |        missing |     -6.33 | 82725.62 | 101426.25 |</span>
<span class="org-table"> | E3608   | 2017-02-28T06:38:00-0700 | 101049.79 |       -1.11 |    71.0 |           0.0 |        missing |     -5.76 | 82725.62 | 101426.23 |</span>
<span class="org-table"> | E3608   | 2017-02-28T07:23:00-0700 | 101049.79 |     missing | missing |       missing |        missing |   missing | 82725.62 |           |</span>
<span class="org-table"> | E3608   | 2017-02-28T08:08:00-0700 | 101049.79 |         0.0 |    67.0 |          0.45 |          184.0 |     -5.47 | 82725.62 | 101343.88 |</span>
<span class="org-table"> | E3608   | 2017-02-28T08:53:00-0700 | 101015.92 |        0.56 |    61.0 |           0.0 |        missing |     -6.18 | 82697.89 | 101268.68 |</span>
<span class="org-table"> | E3608   | 2017-02-28T09:38:00-0700 | 100982.06 |        2.22 |    51.0 |          1.34 |          136.0 |     -6.98 | 82670.17 | 101113.58 |</span>
<span class="org-table"> | E3608   | 2017-02-28T10:23:00-0700 | 101015.92 |        3.33 |    44.0 |           0.9 |          141.0 |     -7.89 | 82697.89 | 101067.33 |</span>
<span class="org-table"> | E3608   | 2017-02-28T11:08:00-0700 | 100982.06 |        3.33 |    44.0 |          2.23 |          133.0 |     -7.89 | 82670.17 | 101033.45 |</span>
<span class="org-table"> | E3608   | 2017-02-28T11:53:00-0700 | 101015.92 |        3.33 |    45.0 |          1.79 |           86.0 |     -7.59 | 82697.89 | 101067.32 |</span>
<span class="org-table"> | E3608   | 2017-02-28T12:38:00-0700 | 100982.06 |        3.33 |    45.0 |          0.45 |          184.0 |     -7.59 | 82670.17 | 101033.44 |</span>
<span class="org-table"> | E3608   | 2017-02-28T13:23:00-0700 |  100948.2 |        4.44 |    43.0 |          1.34 |           96.0 |     -7.17 | 82642.45 | 100920.11 |</span>
<span class="org-table"> | E3608   | 2017-02-28T14:08:00-0700 | 100982.06 |         5.0 |    42.0 |           0.9 |          128.0 |     -6.97 | 82670.17 | 100914.12 |</span>
<span class="org-table"> | E3608   | 2017-02-28T14:53:00-0700 | 101049.79 |        3.33 |    58.0 |          2.23 |          100.0 |     -4.24 | 82725.62 | 101101.09 |</span>
<span class="org-table"> | E3608   | 2017-02-28T15:38:00-0700 | 101151.38 |        2.78 |    61.0 |          1.34 |           85.0 |     -4.08 | 82808.78 | 101242.41 |</span>
<span class="org-table"> | E3608   | 2017-02-28T16:28:00-0700 | 101354.56 |        2.22 |    64.0 |          2.23 |          355.0 |     -3.97 | 82975.12 | 101486.45 |</span>
<span class="org-special-keyword">:END:</span>

<span class="org-level-2">** Timeseries with Gnuplot</span>
<span class="org-level-3">*** Plot Dimensions </span><span class="org-tag"><span class="org-level-3">:noexport:</span></span>

A little spreadsheet to help me find the plot dimensions and locations.

<span class="org-table">| Top Header     |  53 | 0.2 | 0.8 |  53 | 227 | 0.24 | 0.76 |</span>
<span class="org-table">| Pressure       | 147 |     |     | 174 |     |      |      |</span>
<span class="org-table">| Temperature    | 200 | 0.2 | 0.6 | 174 | 174 | 0.17 | 0.59 |</span>
<span class="org-table">| RH             | 200 | 0.2 | 0.4 | 174 | 174 | 0.17 | 0.42 |</span>
<span class="org-table">| Wind speed     | 200 | 0.2 | 0.2 | 174 | 174 | 0.17 | 0.25 |</span>
<span class="org-table">| Wind direction | 127 | 0.2 | 0.0 | 174 | 247 | 0.25 |  0.0 |</span>
<span class="org-table">| Bottom Labels  |  73 |     |     |  73 |     |      |      |</span>

<span class="org-level-3">*** Gnuplot</span>

At this point, we are ready to plot our data table with gnuplot. The following code took bit of experimentation to get right as well as studying the <span class="org-link"><a href="http://gnuplot.sourceforge.net/documentation.html">gnuplot official documentation</a></span>. But essentially we are plotting in one stacked plot,

  - Sea level pressure
  - Temperature and dew point
  - Relative humidity
  - Wind speed
  - Wind direction

One tricky part, is I had to alternate the Y-axis labeling so that the successive plot labels would not run into one another.

<span class="org-block-begin-line">#+begin_src gnuplot :var data=data-table :noweb yes :file ../../static/weatherobs/timeseries.svg
</span>  <span class="constant">reset</span>

  <span class="constant">set</span> terminal svg size 800, 800 enhanced truecolor font 'Verdana,13'

  <span class="constant">set</span> multiplot layout 5,1 rowsfirst

  <span class="constant">set</span> grid
  <span class="constant">set</span> lmargin 12
  <span class="constant">set</span> rmargin 8

  <span class="constant">set</span> style line 1 lc rgb '#000000' <span class="type">lt</span> 1 <span class="type">lw</span> 2 <span class="type">pt</span> 9 <span class="type">ps</span> 1.0
  <span class="constant">set</span> style line 2 lc rgb '#dd181f' <span class="type">lt</span> 1 <span class="type">lw</span> 2 <span class="type">pt</span> 7 <span class="type">ps</span> 1.0
  <span class="constant">set</span> style line 3 lc rgb '#0060ad' <span class="type">lt</span> 1 <span class="type">lw</span> 2 <span class="type">pt</span> 7 <span class="type">ps</span> 0.75
  <span class="constant">set</span> style line 4 lc rgb '#00ff00' <span class="type">lt</span> 1 <span class="type">lw</span> 2 <span class="type">pt</span> 7 <span class="type">ps</span> 1
  <span class="constant">set</span> style line 5 lc rgb '#00ff00' <span class="type">lt</span> 1 <span class="type">lw</span> 2 <span class="type">pt</span> 5 <span class="type">ps</span> 0.75

  <span class="constant">set</span> <span class="type">title</span> "Weather for &lt;&lt;station-id()&gt;&gt;"

  <span class="constant">set</span> xdata time
  <span class="constant">set</span> timefmt "%Y-%m-%dT%H:%M:%SZ"
  <span class="constant">set</span> format x " " 

  <span class="constant">set</span> yrange [<span class="constant">:*</span>]
  <span class="constant">set</span> ylabel "Pascals" offset 0

  <span class="constant">set</span> bmargin 0
  <span class="constant">set</span> offsets graph 0, 0, 500, 10

  <span class="constant">set</span> size 1,0.24
  <span class="constant">set</span> origin 0.0,0.76

  <span class="keyword">plot</span> data <span class="type">using</span> " Date Time":"SLP" <span class="type">with</span> <span class="function-name">linespoints</span> <span class="type">ls</span> 1 <span class="type">title</span> 'Sea Level Pressure'

  <span class="constant">set</span> <span class="type">title</span> " "

  <span class="constant">set</span> yrange [<span class="constant">:*</span>]
  <span class="constant">set</span> ytics offset 80,0
  <span class="constant">set</span> ylabel "Celsius" offset 88

  <span class="constant">set</span> tmargin 0
  <span class="constant">set</span> offsets graph 0, 0, 10, 1

  <span class="constant">set</span> size 1,0.17
  <span class="constant">set</span> origin 0.0,0.59

  <span class="keyword">plot</span> data <span class="type">using</span> "Date Time":"Temperature" <span class="type">with</span> <span class="function-name">linespoints</span> <span class="type">ls</span> 2 <span class="type">title</span> 'Temperature',\
       data <span class="type">using</span> "Date Time":"Dew Point" <span class="type">with</span> <span class="function-name">linespoints</span> <span class="type">ls</span> 3 <span class="type">title</span> 'Dewpoint'

  <span class="constant">set</span> yrange [<span class="constant">0:100</span>]
  <span class="constant">set</span> ytics offset 0,0
  <span class="constant">set</span> ylabel "%" offset 0

  <span class="constant">set</span> offsets graph 0, 0, 0, 0 

  <span class="constant">set</span> size 1,0.17
  <span class="constant">set</span> origin 0.0,0.42

  <span class="keyword">plot</span> data <span class="type">using</span> "Date Time":"RH" <span class="type">with</span> <span class="function-name">linespoints</span> <span class="type">ls</span> 4 <span class="type">title</span> 'RH'

  <span class="constant">set</span> yrange [<span class="constant">0:*</span>]
  <span class="constant">set</span> ytics offset 80,0
  <span class="constant">set</span> ylabel "Meters per Second" offset 88

  <span class="constant">set</span> offsets graph 0, 0, 1, 0

  <span class="constant">set</span> size 1,0.17
  <span class="constant">set</span> origin 0.0,0.25

  <span class="keyword">plot</span> data <span class="type">using</span> " Date Time":"Wind Speed" <span class="type">with</span> <span class="function-name">linespoints</span> <span class="type">ls</span> 5 <span class="type">title</span> 'Wind Speed'

  <span class="constant">set</span> xtics rotate by -45
  <span class="constant">set</span> format x "%m/%d %Hh"

  <span class="constant">set</span> yrange [<span class="constant">0:360</span>]
  <span class="constant">set</span> ylabel "Direction" offset 0
  <span class="constant">set</span> ytics ("N" 0,"NE" 45,"E" 90 ,"SE" 135, "S" 180, "SW" 225, "W" 270, "NW" 315) offset 0,0

  <span class="constant">set</span> bmargin 4

  <span class="constant">set</span> size 1,0.25
  <span class="constant">set</span> origin 0.0,0

  <span class="keyword">plot</span> data <span class="type">using</span> " Date Time":"Wind Direction" <span class="type">pt</span> 3 <span class="type">ps</span> 1.0 <span class="type">title</span> 'Wind Direction'

  <span class="constant">unset</span> multiplot
<span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+RESULTS:</span>
<img src="../../static/weatherobs/timeseries.svg" alt="file:../../static/weatherobs/timeseries.svg" />

<span class="org-level-2">** Babel</span>

As mentioned in the <span class="org-link"><a href="intro">introduction</a></span>, to generate the data table and plot, , this entire buffer can be run in literate programming fashion with <span class="org-code">~org-babel-execute-buffer~</span> (<span class="org-code">~C-c C-v C-b~</span>). You can parameterize the start and end time, and the station ID via <span class="org-link"><a href="params">noweb parameters</a></span>. I will leave it as an exercise to the reader to supply additional parameterization for the station variables, for example.

<span class="org-level-2">** Ideas for Improvements</span>

In the future, I would like to incorporate more information in the plot. Specifically,

  - Replace the wind and direction time series with wind barbs.
  - <span class="org-link"><a href="http://www.wpc.ncep.noaa.gov/html/stationplot.shtml">Station plot weather symbols</a></span> 
  - Add precipitation data

I'll have to learn more about gnuplot in order to achieve the first two bullet items.
</pre>
  </body>
</html>
